{{ "#!/bin/bash" }}
# System information utilities - Enterprise-grade helper functions
# Used by MOTD scripts for consistent data retrieval and formatting

set -euo pipefail

# Color definitions for terminal output
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly CYAN='\033[0;36m'
readonly WHITE='\033[1;37m'
readonly NC='\033[0m'

# Logging function for debugging
log_debug() {
    if [[ "${DEBUG:-false}" == "true" ]]; then
        echo "[DEBUG] $*" >&2
    fi
}

# Safe fact retrieval with fallback
get_fact_value() {
    local fact_file="$1"
    local json_path="$2"
    local default_value="${3:-N/A}"

    if [[ -f "$fact_file" ]]; then
        jq -r "$json_path // \"$default_value\"" "$fact_file" 2>/dev/null || echo "$default_value"
    else
        echo "$default_value"
    fi
}

# Get system load status with color coding
get_load_status() {
    local load_avg
    load_avg=$(uptime | awk -F'load average:' '{print $2}' | awk '{print $1}' | tr -d ',')
    local cpu_cores
    cpu_cores=$(nproc)
    local load_threshold=$((cpu_cores))

    if (( $(echo "$load_avg > $load_threshold" | bc -l) )); then
        echo -e "${RED}HIGH${NC}"
    elif (( $(echo "$load_avg > $(echo "$load_threshold * 0.7" | bc -l)" | bc -l) )); then
        echo -e "${YELLOW}MODERATE${NC}"
    else
        echo -e "${GREEN}OK${NC}"
    fi
}

# Get memory usage with color coding
get_memory_status() {
    local mem_percent
    mem_percent=$(free | awk 'NR==2{printf "%.0f", $3*100/$2}')

    if [[ $mem_percent -gt 90 ]]; then
        echo -e "${RED}CRITICAL (${mem_percent}%)${NC}"
    elif [[ $mem_percent -gt 75 ]]; then
        echo -e "${YELLOW}WARNING (${mem_percent}%)${NC}"
    else
        echo -e "${GREEN}OK (${mem_percent}%)${NC}"
    fi
}

# Get disk usage with color coding
get_disk_status() {
    local disk_percent
    disk_percent=$(df / | awk 'NR==2{print int($5)}')

    if [[ $disk_percent -gt 90 ]]; then
        echo -e "${RED}CRITICAL (${disk_percent}%)${NC}"
    elif [[ $disk_percent -gt 80 ]]; then
        echo -e "${YELLOW}WARNING (${disk_percent}%)${NC}"
    else
        echo -e "${GREEN}OK (${disk_percent}%)${NC}"
    fi
}

# Get service status with color coding
get_service_status() {
    local service_name="$1"

    if systemctl is-active "$service_name" &>/dev/null; then
        echo -e "${GREEN}RUNNING${NC}"
    elif systemctl is-enabled "$service_name" &>/dev/null; then
        echo -e "${YELLOW}STOPPED${NC}"
    else
        echo -e "${CYAN}DISABLED${NC}"
    fi
}

# Check for security updates
get_security_updates() {
    local update_count

    case "$(grep '^ID=' /etc/os-release | cut -d'=' -f2 | tr -d '"')" in
        ubuntu|debian)
            update_count=$(apt list --upgradable 2>/dev/null | grep -c security || echo "0")
            ;;
        centos|rhel|rocky|almalinux)
            update_count=$(yum check-update --security 2>/dev/null | grep -c "updates" || echo "0")
            ;;
        *)
            update_count="unknown"
            ;;
    esac

    if [[ "$update_count" == "0" ]]; then
        echo -e "${GREEN}UP TO DATE${NC}"
    elif [[ "$update_count" =~ ^[0-9]+$ ]] && [[ $update_count -gt 0 ]]; then
        echo -e "${YELLOW}${update_count} AVAILABLE${NC}"
    else
        echo -e "${CYAN}UNKNOWN${NC}"
    fi
}

# Format uptime in human readable format
get_uptime_human() {
    uptime -p 2>/dev/null || uptime | awk '{print $3,$4}' | sed 's/,//'
}

# Get container count for Docker/Podman
get_container_count() {
    local runtime="$1"

    case "$runtime" in
        docker)
            if command -v docker &>/dev/null && systemctl is-active docker &>/dev/null; then
                docker ps -q | wc -l
            else
                echo "0"
            fi
            ;;
        podman)
            if command -v podman &>/dev/null; then
                podman ps -q | wc -l
            else
                echo "0"
            fi
            ;;
        *)
            echo "0"
            ;;
    esac
}

# Export functions for use in MOTD scripts
export -f log_debug get_fact_value get_load_status get_memory_status
export -f get_disk_status get_service_status get_security_updates
export -f get_uptime_human get_container_count
