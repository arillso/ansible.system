---
# File: roles/system_tuning/tasks/io_scheduler.yml
# Configure I/O scheduler settings with proper validation

- name: Create udev rules directory
  ansible.builtin.file:
      path: /etc/udev/rules.d
      state: directory
      mode: "0755"
      owner: root
      group: root
  become: true

- name: Configure I/O scheduler via udev rule
  ansible.builtin.template:
      src: etc/udev/rules.d/60-io-scheduler.rules.j2
      dest: /etc/udev/rules.d/60-io-scheduler.rules
      mode: "0644"
      owner: root
      group: root
      backup: true
  become: true
  notify: Reload udev
  when: optimized_storage_devices is defined and optimized_storage_devices | length > 0

- name: Apply I/O scheduler immediately for each device
  block:
      - name: Check current I/O scheduler
        ansible.builtin.slurp:
            src: "/sys/block/{{ item.name }}/queue/scheduler"
        register: current_scheduler
        failed_when: false
        loop: "{{ optimized_storage_devices }}"

      - name: Set I/O scheduler immediately
        ansible.builtin.shell: |
            echo "{{ item.item.scheduler }}" > /sys/block/{{ item.item.name }}/queue/scheduler
        become: true
        register: scheduler_result
        failed_when: false
        changed_when: scheduler_result.rc == 0
        when:
            - not item.failed
            - item.item.scheduler not in (item.content | b64decode)
        loop: "{{ current_scheduler.results }}"

      - name: Report I/O scheduler configuration status
        ansible.builtin.debug:
            msg: >-
                Device {{ item.item.name }} ({{ item.item.type }}):
                {% if item.failed -%}
                Could not access scheduler settings{%- elif scheduler_result.results[loop.index0].changed -%}
                Changed to {{ item.item.scheduler }}{%- else -%}
                Already using {{ item.item.scheduler }}{%- endif %}
        loop: "{{ current_scheduler.results }}"
        loop_control:
            extended: true

- name: Verify I/O scheduler configuration
  block:
      - name: Read final I/O scheduler settings
        ansible.builtin.slurp:
            src: "/sys/block/{{ item.name }}/queue/scheduler"
        register: final_scheduler
        failed_when: false
        loop: "{{ optimized_storage_devices }}"

      - name: Validate I/O scheduler was applied
        ansible.builtin.assert:
            that:
                - not item.failed
                - ('[' + item.item.scheduler + ']') in (item.content | b64decode)
            fail_msg: "Failed to set I/O scheduler {{ item.item.scheduler }} for device {{ item.item.name }}"
            success_msg: "I/O scheduler {{ item.item.scheduler }} successfully applied to {{ item.item.name }}"
        loop: "{{ final_scheduler.results }}"
        when: not ansible_check_mode
